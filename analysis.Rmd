---
title: "Airline Passenger Satisfaction Classification"
author: "SÃ¼leyman Erim, Giacomo Schiavo, Mattia Varagnolo"
date: "30.05.2023"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:



```{r message=FALSE}
# import libraries
library(tidyverse)
library(knitr)
```


```{r message=FALSE}
# import datasets
data_train = read.csv("train.csv")
data_test = read.csv("test.csv")
```

```{r, message=FALSE}
# merge train and test data
data = rbind(data_train, data_test)
attach(data)
```



```{r}
# dimension of data
print(dim(data))
```


```{r echo = FALSE}
summary(data)
```

```{r}
# replace dots with underscores in column names
names(data) = gsub("\\.", "_", names(data))
```

```{r}
# print column names
print(names(data))
```


```{r}
# drop X and id column
#TODO: explain why
data = data %>% select(-X, -id)
```


```{r}
# insert all categorical variables into a list
categorical_var = c(data$Cleanliness,
  data$Inflight_wifi_service,
  data$Departure_Arrival_time_convenient,
  data$Ease_of_Online_booking,
  data$Gate_location,
  data$Food_and_drink,
  data$Online_boarding,
  data$Seat_comfort,
  data$Inflight_entertainment,
  data$On_board_service,
  data$Leg_room_service,
  data$Baggage_handling,
  data$Checkin_service,
  data$Inflight_service,
  data$Cleanliness
)

# convert categorical variables to factors and then to numeric
categorical_var = as.factor(categorical_var)
categorical_var = as.numeric(categorical_var)

# convert gender to numeric and then to factor
data$Gender = as.numeric(as.factor(data$Gender))

# change type of customer to 0 and disloyal customer to 1
data$Customer_Type = as.numeric(factor(data$Customer_Type, levels = c("Loyal Customer", "disloyal Customer"))) - 1

# change type of tr avel to 0 and personal travel to 1
data$Type_of_Travel = as.numeric(factor(data$Type_of_Travel, levels = c("Personal Travel", "Business travel"))) - 1

# change class Business is 2, Eco Plus is 1 and Eco is 0
data$Class = as.numeric(factor(data$Class, levels = c("Business", "Eco Plus", "Eco"))) - 1

data$satisfaction = as.numeric(factor(data$satisfaction, levels = c("neutral or dissatisfied", "satisfied"))) - 1
```


```{r}
# drop na values in Arrival Delay in Minutes
# TODO: explain why (now it's dropped to simplify the analysis)
data = data %>% drop_na(Arrival_Delay_in_Minutes)

```

```{r}
# DATA BALANCE: quite balanced
kable(prop.table(table(data$satisfaction)),caption="dataset distribution",col.names = c("Satisfaction","Frequency"))

```

```{r}
# Train-test split
set.seed(123)
train_index = sample(1:nrow(data), 0.8*nrow(data))
# 80% of data is used for training
train = data[train_index,]
# 20% of data is used for testing
test = data[-train_index,]

# print dimension of train and test data
dim(train)
dim(test)
```

```{r}
# save true values of test satisfaction column
test_true = test$satisfaction
```

```{r}
# drop satisfaction column from test data
test = test %>% select(-satisfaction)
```

```{r}
# print proportion of satisfied and dissatisfied customers in train and test data
prop.table(table(train$satisfaction))
prop.table(table(test_true))
```

## DATA ANALYSIS

```{r}
# save satisfaction column of train data
train_satisfaction = train$satisfaction
```


```{r}
# correlation matrix only for numeric variables
correlation_matrix = cor(train[, sapply(train, is.numeric)])
```


```{r}
# plot correlation matrix
library(corrplot)
corrplot(correlation_matrix, method = "circle")
```

train

## LOGISTIC REGRESSION

```{r}
# Model definition:
glm_compl<- glm(data = train,
                satisfaction ~ .,
                family = "binomial")
# We compute the reference level R-Squared
s<- summary(glm_compl)
r2<- 1 - (s$deviance/s$null.deviance)
1/(1-r2)
```
```{r}
# VIF Iteration 1 
# Using the VIF function and comparing the obtained values with the
# computed quantity:
# (The process is done iteratively where we delete one variable at time)
library(regclass)
vif_values <- VIF(glm_compl)



# Create a data frame with variable names and their corresponding VIF values
vif_df <- data.frame(Variable = names(vif_values), VIF = vif_values,row.names = NULL)

# Sort the data frame in decreasing order of VIF values
sorted_df <- vif_df[order(-vif_df$VIF), ]

# Print the sorted data frame
print(sorted_df)
```
```{r}
# VIF Iteration 2
# Using the VIF function and comparing the obtained values with the
# computed quantity:
# (The process is done iteratively where we delete one variable at time)
# Model definition:
glm_compl<- glm(data = train,
                satisfaction ~ .-Arrival_Delay_in_Minutes,
                family = "binomial")
vif_values <- VIF(glm_compl)

# Create a data frame with variable names and their corresponding VIF values
vif_df <- data.frame(Variable = names(vif_values), VIF = vif_values,row.names = NULL)

# Sort the data frame in decreasing order of VIF values
sorted_df <- vif_df[order(-vif_df$VIF), ]

# Print the sorted data frame
print(sorted_df)
```



```{r}
# VIF Iteration 3
# Using the VIF function and comparing the obtained values with the
# computed quantity:
# (The process is done iteratively where we delete one variable at time)
# Model definition:
glm_compl<- glm(data = train,
                satisfaction ~ .-Arrival_Delay_in_Minutes-Inflight_entertainment,
                family = "binomial")
vif_values <- VIF(glm_compl)

# Create a data frame with variable names and their corresponding VIF values
vif_df <- data.frame(Variable = names(vif_values), VIF = vif_values,row.names = NULL)

# Sort the data frame in decreasing order of VIF values
sorted_df <- vif_df[order(-vif_df$VIF), ]

# Print the sorted data frame
print(sorted_df)
```


```{r}
# VIF Iteration 4
# Using the VIF function and comparing the obtained values with the
# computed quantity:
# (The process is done iteratively where we delete one variable at time)
# Model definition:
glm_compl<- glm(data = train,
                satisfaction ~ .-Arrival_Delay_in_Minutes-Inflight_entertainment
                -Ease_of_Online_booking	,
                family = "binomial")
vif_values <- VIF(glm_compl)

# Create a data frame with variable names and their corresponding VIF values
vif_df <- data.frame(Variable = names(vif_values), VIF = vif_values,row.names = NULL)

# Sort the data frame in decreasing order of VIF values
sorted_df <- vif_df[order(-vif_df$VIF), ]

# Print the sorted data frame
print(sorted_df)
```


```{r}
# VIF Iteration 5
# Using the VIF function and comparing the obtained values with the
# computed quantity:
# (The process is done iteratively where we delete one variable at time)
# Model definition:
glm_compl<- glm(data = train,
                satisfaction ~ .-Arrival_Delay_in_Minutes-Inflight_entertainment
                -Ease_of_Online_booking - Cleanliness	,
                family = "binomial")
vif_values <- VIF(glm_compl)

# Create a data frame with variable names and their corresponding VIF values
vif_df <- data.frame(Variable = names(vif_values), VIF = vif_values,row.names = NULL)

# Sort the data frame in decreasing order of VIF values
sorted_df <- vif_df[order(-vif_df$VIF), ]

# Print the sorted data frame
print(sorted_df)
```

```{r}
glm_compl<- glm(data = train,
                satisfaction ~ .-Arrival_Delay_in_Minutes-Inflight_entertainment
                -Ease_of_Online_booking - Cleanliness	,
                family = "binomial")
# Observation of the model summary:
summary(glm_compl)
```
```{r}
glm_compl<- glm(data = train,
                satisfaction ~ .-Arrival_Delay_in_Minutes-Inflight_entertainment
                -Ease_of_Online_booking - Cleanliness
                -Flight_Distance -Gate_location,
                family = "binomial")
# Observation of the model summary:
summary(glm_compl)
```
```{r}
glm_compl<- glm(data = train,
                satisfaction ~ .-Arrival_Delay_in_Minutes-Inflight_entertainment
                -Ease_of_Online_booking - Cleanliness
                -Flight_Distance -Gate_location,
                family = "binomial")


# Computing the predictions with the model on the test set:
pred_glm_compl<- predict(glm_compl, test, type = "response")

# Converting the prediction in {0,1} according to the chosen threshold:

threshold4<- 0.4
threshold5<- 0.5
threshold6<- 0.6

pred_glm_compl_04<- ifelse(pred_glm_compl > threshold4, 1, 0)
pred_glm_compl_05<- ifelse(pred_glm_compl > threshold5, 1, 0)
pred_glm_compl_06<- ifelse(pred_glm_compl > threshold6, 1, 0)
```




```{r}
# Confusion matrix with threshold = 0.4
table(test_true, pred_glm_compl_04)
mean(pred_glm_compl_04==test_true)

# Confusion matrix with threshold = 0.5
table(test_true, pred_glm_compl_05)
mean(pred_glm_compl_05==test_true)

# Confusion matrix with threshold = 0.6
table(test_true, pred_glm_compl_06)
mean(pred_glm_compl_06==test_true)
```

